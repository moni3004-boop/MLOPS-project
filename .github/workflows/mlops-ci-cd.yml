name: MLOps End-to-End Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-test-secure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "kfp==2.*" pip-audit

      - name: Compile pipeline
        run: |
          mkdir -p pipeline
          if [ -f adult_income_end2end_pipeline.py ]; then
            python adult_income_end2end_pipeline.py
          elif [ -f pipeline/kfp_pipeline.py ]; then
            python pipeline/kfp_pipeline.py
          else
            echo "No pipeline compile script found"
            exit 1
          fi
          ls -la pipeline
          test -f pipeline/adult_income_end2end.yaml

      - name: Upload compiled pipeline artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pipeline
          path: pipeline/adult_income_end2end.yaml
          if-no-files-found: error


  cd-upload-kubeflow:
    needs: build-test-secure
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, Linux, X64, kfp, participant-17]
    timeout-minutes: 30

    steps:
      - name: Download compiled pipeline artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-pipeline
          path: ./pipeline

      - name: Verify artifact
        run: |
          ls -la ./pipeline
          test -f ./pipeline/adult_income_end2end.yaml

      - name: Upload pipeline + create/get experiment + trigger run (curl)
        env:
          KFP_HOST: ${{ secrets.KFP_HOST }}
          KFP_BEARER_TOKEN: ${{ secrets.KFP_BEARER_TOKEN }}
          KFP_NAMESPACE: participant-17
          EXPERIMENT_NAME: ci-experiment
        run: |
          set -euo pipefail

          # KFP uses the uploadfile *filename* as pipeline name -> must be unique
          SRC_FILE="./pipeline/adult_income_end2end.yaml"
          UNIQUE_FILE="./pipeline/adult-income-end2end-${GITHUB_SHA::7}.yaml"
          cp "$SRC_FILE" "$UNIQUE_FILE"

          echo "KFP_HOST=$KFP_HOST"
          echo "Namespace=$KFP_NAMESPACE"
          echo "Experiment=$EXPERIMENT_NAME"
          echo "UploadFile=$UNIQUE_FILE"

          # 0) Probe
          curl -sS -D /tmp/hdrs.txt -o /tmp/body.txt \
            -H "Authorization: Bearer $KFP_BEARER_TOKEN" \
            -H "X-User-Namespace: $KFP_NAMESPACE" \
            "$KFP_HOST/apis/v1beta1/healthz"

          if grep -qi "text/html" /tmp/hdrs.txt; then
            echo "❌ Got HTML (Dex). KFP_HOST must be in-cluster ml-pipeline service."
            head -c 300 /tmp/body.txt || true
            exit 2
          fi
          echo "✅ healthz ok: $(cat /tmp/body.txt)"

          # 1) Upload pipeline (name comes from UNIQUE_FILE filename!)
          curl -sS -D /tmp/up_hdrs.txt -o /tmp/up_body.txt \
            -H "Authorization: Bearer $KFP_BEARER_TOKEN" \
            -H "X-User-Namespace: $KFP_NAMESPACE" \
            -F "uploadfile=@${UNIQUE_FILE};type=application/yaml" \
            "$KFP_HOST/apis/v1beta1/pipelines/upload"

          if ! grep -Eq "HTTP/.* (200|201)" /tmp/up_hdrs.txt; then
            echo "❌ Upload failed:"
            cat /tmp/up_hdrs.txt || true
            head -c 900 /tmp/up_body.txt || true
            exit 3
          fi

          echo "Upload response:"
          cat /tmp/up_body.txt

          PIPELINE_ID=$(cat /tmp/up_body.txt | sed -n 's/.*"id":"\([^"]*\)".*/\1/p' | head -n 1)
          if [ -z "${PIPELINE_ID:-}" ]; then
            echo "❌ Could not parse pipeline id from upload response"
            exit 4
          fi
          echo "✅ PIPELINE_ID=$PIPELINE_ID"

          # 2) Find or create experiment
          curl -sS -o /tmp/exp_list.json \
            -H "Authorization: Bearer $KFP_BEARER_TOKEN" \
            -H "X-User-Namespace: $KFP_NAMESPACE" \
            "$KFP_HOST/apis/v1beta1/experiments?page_size=200&namespace=$KFP_NAMESPACE"

          EXP_ID=$(cat /tmp/exp_list.json | tr '\n' ' ' | sed -n "s/.*\"id\":\"\\([^\"]*\\)\",\"name\":\"$EXPERIMENT_NAME\".*/\\1/p" | head -n 1)

          if [ -z "${EXP_ID:-}" ]; then
            echo "Experiment not found -> creating..."
            curl -sS -o /tmp/exp_create.json \
              -X POST \
              -H "Authorization: Bearer $KFP_BEARER_TOKEN" \
              -H "X-User-Namespace: $KFP_NAMESPACE" \
              -H "Content-Type: application/json" \
              "$KFP_HOST/apis/v1beta1/experiments" \
              -d "{\"name\":\"$EXPERIMENT_NAME\",\"namespace\":\"$KFP_NAMESPACE\"}"

            cat /tmp/exp_create.json
            EXP_ID=$(cat /tmp/exp_create.json | sed -n 's/.*"id":"\([^"]*\)".*/\1/p' | head -n 1)
          fi

          if [ -z "${EXP_ID:-}" ]; then
            echo "❌ Could not get/create experiment id"
            exit 5
          fi
          echo "✅ EXPERIMENT_ID=$EXP_ID"

          # 3) Trigger run
          RUN_NAME="ci-run-${GITHUB_SHA::7}-$(date +%s)"
          echo "== Trigger run: $RUN_NAME =="

          curl -sS -D /tmp/run_hdrs.txt -o /tmp/run_body.txt \
            -X POST \
            -H "Authorization: Bearer $KFP_BEARER_TOKEN" \
            -H "X-User-Namespace: $KFP_NAMESPACE" \
            -H "Content-Type: application/json" \
            "$KFP_HOST/apis/v1beta1/runs" \
            -d "{
              \"name\": \"${RUN_NAME}\",
              \"experiment_id\": \"${EXP_ID}\",
              \"pipeline_spec\": { \"pipeline_id\": \"${PIPELINE_ID}\" }
            }"

          if ! grep -Eq "HTTP/.* (200|201)" /tmp/run_hdrs.txt; then
            echo "❌ Run create failed:"
            cat /tmp/run_hdrs.txt || true
            head -c 900 /tmp/run_body.txt || true
            exit 6
          fi

          echo "✅ Run created:"
          cat /tmp/run_body.txt