name: MLOps End-to-End Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-test-secure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install kfp==2.* pip-audit

      - name: Compile pipeline
        run: |
          mkdir -p pipeline
          if [ -f adult_income_end2end_pipeline.py ]; then
            python adult_income_end2end_pipeline.py
          elif [ -f pipeline/kfp_pipeline.py ]; then
            python pipeline/kfp_pipeline.py
          else
            echo "No pipeline compile script found"
            exit 1
          fi
          ls -la pipeline
          test -f pipeline/adult_income_end2end.yaml

      - name: Dependency security scan
        run: |
          pip-audit || true

      - name: Docker build
        run: |
          docker build -t adult-income-api:ci -f docker/Dockerfile .

      - name: Upload compiled pipeline artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pipeline
          path: pipeline/adult_income_end2end.yaml


  cd-upload-kubeflow:
    needs: build-test-secure
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Download compiled pipeline artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-pipeline
          path: ./pipeline

      - name: Verify artifact
        run: |
          ls -la ./pipeline
          test -f ./pipeline/adult_income_end2end.yaml

      - name: Upload pipeline to Kubeflow Pipelines (Cookie + Namespace header)
        env:
          # ✅ ОВА СТАВИ ГО ВО SECRET KFP_HOST:
          # https://kubeflow-mlops-training.scalefocus.cloud
          KFP_HOST: ${{ secrets.KFP_HOST }}

          # ✅ ОВА СТАВИ ГО ВО SECRET KFP_COOKIE:
          # authservice_session=...
          KFP_COOKIE: ${{ secrets.KFP_COOKIE }}

          # твојот namespace
          KFP_NAMESPACE: participant-17

          PIPELINE_NAME: adult-income-end2end
        run: |
          python -m pip install --upgrade pip
          pip install requests

          python - <<'PY'
          import os, sys, requests

          base = os.environ["KFP_HOST"].rstrip("/")
          cookie = os.environ["KFP_COOKIE"].strip()
          ns = os.environ["KFP_NAMESPACE"].strip()
          name = os.environ["PIPELINE_NAME"].strip()

          file_path = "./pipeline/adult_income_end2end.yaml"

          # ✅ KFP upload endpoint behind Kubeflow multi-user path
          upload_url = f"{base}/_/pipeline/apis/v1beta1/pipelines/upload"

          headers = {
              "Cookie": cookie,
              "X-User-Namespace": ns,
          }

          # quick auth probe (must be JSON or plain ok, not HTML)
          probe_url = f"{base}/_/pipeline/apis/v1beta1/healthz"
          pr = requests.get(probe_url, headers=headers, timeout=15)
          pct = (pr.headers.get("content-type") or "").lower()
          print("Probe:", probe_url, "->", pr.status_code, pct)
          if "text/html" in pct:
              print("❌ Still getting HTML (Dex). Cookie is invalid/expired or missing cookies.")
              print("First200:", pr.text[:200].replace("\n"," "))
              sys.exit(2)

          with open(file_path, "rb") as f:
              files = {"uploadfile": (os.path.basename(file_path), f, "application/yaml")}
              data = {"name": name, "description": "Uploaded from GitHub Actions"}
              r = requests.post(upload_url, headers=headers, files=files, data=data, timeout=120)

          ct = (r.headers.get("content-type") or "").lower()
          print("POST:", upload_url)
          print("Status:", r.status_code, "Content-Type:", ct)

          if "text/html" in ct:
              print("❌ Got HTML (Dex). Cookie not accepted.")
              print("First200:", r.text[:200].replace("\n"," "))
              sys.exit(3)

          if r.status_code >= 400:
              print("❌ Upload failed:", r.text[:800])
              sys.exit(4)

          print("✅ Upload OK. Response (first 800):")
          print(r.text[:800])
          PY