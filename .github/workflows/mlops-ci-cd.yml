name: MLOps End-to-End Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-test-secure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install kfp pip-audit

      - name: Compile pipeline
        run: |
          mkdir -p pipeline
          if [ -f adult_income_end2end_pipeline.py ]; then
            python adult_income_end2end_pipeline.py
          elif [ -f pipeline/kfp_pipeline.py ]; then
            python pipeline/kfp_pipeline.py
          else
            echo "No pipeline compile script found"
            exit 1
          fi
          ls -la pipeline || true

      - name: Dependency security scan
        run: |
          pip-audit || true

      - name: Docker build
        run: |
          docker build -t adult-income-api:ci -f docker/Dockerfile .

      - name: Upload compiled pipeline
        uses: actions/upload-artifact@v4
        with:
          name: compiled-pipeline
          path: pipeline/adult_income_end2end.yaml

  cd-upload-kubeflow:
    needs: build-test-secure
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Download compiled pipeline artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-pipeline
          path: ./pipeline

      - name: Show files
        run: |
          ls -la ./pipeline
          test -f ./pipeline/adult_income_end2end.yaml

      - name: Upload pipeline to Kubeflow Pipelines (KFP)
        env:
          # 1) KFP endpoint (пример: https://<kubeflow-host>/pipeline)
          KFP_HOST: ${{ secrets.KFP_HOST }}

          # 2A) Ако користиш Cookie auth (Dex/istio):
          KFP_COOKIE: ${{ secrets.KFP_COOKIE }}

          # 2B) Ако користиш Bearer token:
          KFP_BEARER_TOKEN: ${{ secrets.KFP_BEARER_TOKEN }}

          # Име за pipeline
          PIPELINE_NAME: "adult-income-end2end"
        run: |
          python -m pip install --upgrade pip
          pip install kfp==2.* requests

          python - << 'PY'
          import os
          from kfp import Client

          host = os.environ["KFP_HOST"].rstrip("/")
          pipeline_path = "./pipeline/adult_income_end2end.yaml"
          pipeline_name = os.environ.get("PIPELINE_NAME", "adult-income-end2end")

          cookie = os.environ.get("KFP_COOKIE", "").strip()
          token = os.environ.get("KFP_BEARER_TOKEN", "").strip()

          # KFP Client може да прими "cookies" преку existing token header со workaround.
          # Најстабилно е ако имаш authservice cookie -> set во env и праќаме преку client._api_client.default_headers.

          client = Client(host=host)

          if cookie:
            client._api_client.default_headers["Cookie"] = cookie
          if token:
            client._api_client.default_headers["Authorization"] = f"Bearer {token}"

          # Upload како pipeline (ако постои, ќе креира нова верзија ако користиш upload_pipeline_version)
          # Најпрост начин: пробај upload_pipeline, ако fail затоа што постои, направи version upload.
          try:
            pipeline_id = client.upload_pipeline(
              pipeline_package_path=pipeline_path,
              pipeline_name=pipeline_name
            )
            print("Uploaded pipeline:", pipeline_id)
          except Exception as e:
            print("upload_pipeline failed, trying upload_pipeline_version. Reason:", e)
            # најди pipeline по име
            plist = client.list_pipelines(page_size=100).pipelines or []
            match = next((p for p in plist if p.name == pipeline_name), None)
            if not match:
              raise
            version_name = "main-" + os.environ.get("GITHUB_SHA","")[:7]
            ver = client.upload_pipeline_version(
              pipeline_package_path=pipeline_path,
              pipeline_version_name=version_name,
              pipeline_id=match.pipeline_id
            )
            print("Uploaded pipeline version:", ver)
          PY