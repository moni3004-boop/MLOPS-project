apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-runner
  namespace: participant-17
spec:
  replicas: 1
  selector:
    matchLabels:
      app: github-runner
  template:
    metadata:
      labels:
        app: github-runner
    spec:
      serviceAccountName: default-editor
      containers:
        - name: runner
          image: python:3.11-slim
          imagePullPolicy: Always
          env:
            - name: REPO_URL
              value: "https://github.com/moni3004-boop/MLOPS-project"
            - name: RUNNER_TOKEN
              value: "B6GIDRW575FFLVDTGW3SOPLJTSNOE"
            - name: RUNNER_NAME
              value: "kubeflow-runner-17"
            - name: RUNNER_LABELS
              value: "kubeflow,linux"
            - name: RUNNER_VERSION
              value: "2.331.0"
          command: ["/bin/bash", "-lc"]
          args:
            - |
              set -e

              apt-get update
              apt-get install -y --no-install-recommends \
                curl ca-certificates unzip git \
                libicu76 libkrb5-3 zlib1g libssl3 \
                liblttng-ust1t64 libnuma1
              rm -rf /var/lib/apt/lists/*

              if ! id -u runner >/dev/null 2>&1; then
                useradd -m -u 1001 -s /bin/bash runner
              fi

              mkdir -p /actions-runner
              chown -R runner:runner /actions-runner
              cd /actions-runner

              echo "Downloading GitHub runner v${RUNNER_VERSION}..."
              curl -fsSL -o actions-runner-linux-x64.tar.gz \
                "https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz"
              tar xzf actions-runner-linux-x64.tar.gz
              rm -f actions-runner-linux-x64.tar.gz
              chown -R runner:runner /actions-runner

              echo "Configuring runner..."
              su - runner -c "cd /actions-runner && ./config.sh \
                --url '${REPO_URL}' \
                --token '${RUNNER_TOKEN}' \
                --name '${RUNNER_NAME}' \
                --labels '${RUNNER_LABELS}' \
                --unattended \
                --replace"

              exec su - runner -c "cd /actions-runner && ./run.sh"
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "1"
              memory: "2Gi"  
              ###test test